---
layout: post
title:  "Arbitrary File Read in Jenkins via args4j (CVE-2024-23897)"
categories: 
tags: jenkins args4j CVE-2024-23897
published: True
---
# Arbitrary File Read in Jenkins via args4j (CVE-2024-23897)
Please note that this analysis covers the vulnerability of `@` expansion, not the entire attack chain possible from [the advisory](https://www.jenkins.io/security/advisory/2024-01-24/).

### Background
The hot thing in the cyber security press this morning (25 JAN 2024) is a vulnerability in Jenkins allowing attackers to read arbitrary files. Jenkins has had a few [vulnerabilities](https://www.cvedetails.com/vulnerability-list/vendor_id-15865/product_id-34004/Jenkins-Jenkins.html) over the years, likely due to its incredible popularity and [dominant marketshare](https://6sense.com/tech/continuos-integration/jenkins-market-share) in the CI/CD space inviting much code analysis and scrutiny.

The large market share along with the sensitive nature the data make it a hugely popular target among attackers. If successful, attackers can pivot into an organization's cloud infrastructure using the highly privileged and long lasting accounts contained within.

When a vulnerability is released for Jenkins, we potentially have a very big issue on our hands, **but is that the case for CVE-2024-23897?** Let's dig in.

### The Announcement
Per Jenkins:
> "This command parser has a feature that replaces an @ character followed by a file path in an argument with the file's contents (expandAtFiles). This feature is enabled by default and Jenkins 2.441 and earlier, LTS 2.426.2 and earlier does not disable it."
> Jenkins 2.442, LTS 2.426.3 disables the command parser feature that replaces an `@` character followed by a file path in an argument with the file’s contents for CLI commands.

### The Code
Examining [the patch](https://github.com/jenkinsci/jenkins/commit/554f03782057c499c49bbb06575f0d28b5200edb) we can see that they have added `ALLOW_AT_SYNTAX` to allow/disallow what was called out in the announcement as the vulnerable code path, the @ file expansion. Also, we can follow the bread crumbs in that code to identify the vulnerable code at `args4j` [here](https://github.com/kohsuke/args4j/blob/b819bd367a70fe102f7a7cab628c2e9f080705fe/args4j/src/org/kohsuke/args4j/CmdLineParser.java#L556):

![patch](/assets/img/CVE-2024-23897/patch.png)


Here we have the logic from `args4j` where we test the first character for `@`-ness, and read all the lines of the file if true:

![arg4j](/assets/img/CVE-2024-23897/readlllines.png)

### The Vulnerability
`@` expansion seems like a convenient feature to launch java applications from the command line using a file full of arguments instead of each argument separately, and I'm not sure I'm comfortable calling it a vulnerability per se. **This vulnerability comes from the chain events leading to arbitrary user input arriving at a command line argument in the first place.** It is important to highlight the difference between this and a wildcard expansion vulnerability, which IMO is much worse due to their arbitrary and unpredictable nature.

### Impact
Do other software projects use this library in a vulnerable way? A [github search](https://github.com/search?q=%22import+org.kohsuke.args4j.CmdLineParser%3B%22+path%3A*.java++NOT+is%3Aarchived&type=Code&ref=advsearch&l=&l=&p=3) reveals that is a pretty popular library, but a quick survey of search results shows most of the importers of this are command line utilities intended to interact with larger projects like these [minecraft utilities](https://github.com/search?q=%22import+org.kohsuke.args4j.CmdLineParser%3B%22+path%3A*.java++NOT+is%3Aarchived+minecraft&type=code&ref=advsearch), or are unlikely to allow rich user interaction via web interface like [stratum-proxy](https://github.com/search?q=%22import+org.kohsuke.args4j.CmdLineParser%3B%22+path%3A*.java++NOT+is%3Aarchived+stratum&type=code&ref=advsearch)

### Conclusion
For these reasons I don't think we have another `log4j` type mega-bug in `args4j`, but rather a fairly straightforward input validation / surprise feature problem that is likely only to be exploited by authenticated users in Jenkins, but will have limited impact in other software utilizing the `args4j`.